name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      initial_setup:
        description: "Run initial EC2 setup (first time only)"
        type: boolean
        default: false

jobs:
  setup:
    name: Initial Setup
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.initial_setup == 'true' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Install Docker and Nginx
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            sudo yum update -y
            sudo yum install docker nginx -y
            sudo systemctl start docker nginx
            sudo systemctl enable docker nginx
            sudo usermod -aG docker $USER
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            mkdir -p ~/ims
          EOF

      - name: Create docker-compose.yml
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cat > ~/ims/docker-compose.yml << 'COMPOSE'
          version: "3.8"

          services:
            frontend:
              image: ${{ secrets.DOCKER_HUB_USERNAME }}/ims-3.9:frontend
              ports:
                - "3000:3000"
              depends_on:
                - backend
              networks:
                - ims-network

            backend:
              image: ${{ secrets.DOCKER_HUB_USERNAME }}/ims-3.9:backend
              ports:
                - "8080:8080"
              environment:
                - SPRING_DATA_MONGODB_HOST=mongodb
                - SPRING_DATA_MONGODB_PORT=27017
                - SPRING_DATA_MONGODB_DATABASE=ims_db_1
                - ALLOWED_ORIGINS=https://www.knoxcloud.tech,http://www.knoxcloud.tech,http://localhost:3000
              depends_on:
                - mongodb
              networks:
                - ims-network

            mongodb:
              image: mongo:5.0
              ports:
                - "27017:27017"
              volumes:
                - mongodb-data:/data/db
              networks:
                - ims-network

          volumes:
            mongodb-data:

          networks:
            ims-network:
              driver: bridge
          COMPOSE
          EOF

      - name: Create Nginx Config
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            sudo tee /etc/nginx/conf.d/ims.conf << 'NGINX'
          server {
              listen 80;
              server_name www.knoxcloud.tech knoxcloud.tech;

              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
              }

              location /api/ {
                  proxy_pass http://localhost:8080/api/api/;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
              }
          }
          NGINX
            sudo nginx -t && sudo systemctl reload nginx
          EOF

      - name: Start Containers
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/ims
            sg docker -c "docker-compose pull"
            sg docker -c "docker-compose up -d"
          EOF

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || (github.event_name == 'workflow_dispatch' && github.event.inputs.initial_setup != 'true') }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/ims
            docker-compose pull
            docker-compose up -d
            docker image prune -f
          EOF

      - name: Health Check
        run: |
          sleep 20
          curl -f https://www.knoxcloud.tech/api/items || echo "Health check failed"
